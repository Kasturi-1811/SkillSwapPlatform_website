{% extends 'skill_swap/base.html' %}

{% block title %}Skill Swap Home{% endblock %}

{% block content %}
<h3 class="mb-4">Find Skill Swappers</h3>

<form method="get" class="row g-2 mb-4 align-items-center">
  <div class="col-auto">
    <label for="availability" class="form-label mb-0">Availability:</label>
  </div>
  <div class="col-auto">
    <select name="availability" id="availability" class="form-select">
      <option value="" {% if not request.GET.availability %}selected{% endif %}>All</option>
      <option value="weekends" {% if request.GET.availability == 'weekends' %}selected{% endif %}>Weekends</option>
      <option value="evenings" {% if request.GET.availability == 'evenings' %}selected{% endif %}>Evenings</option>
    </select>
  </div>

  <div class="col-auto flex-grow-1">
    <input
      type="text"
      name="q"
      placeholder="Search skills..."
      value="{{ request.GET.q|default_if_none:'' }}"
      class="form-control"
      aria-label="Search skills"
    />
  </div>

  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Search</button>
  </div>
</form>

{% if user.is_authenticated %}
  <h4>Incoming Swap Requests</h4>
  {% if incoming_requests %}
    <ul class="list-group mb-4">
      {% for req in incoming_requests %}
        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
          <div>
            <strong>{{ req.from_user.username }}</strong> wants to swap
            <em>{{ req.offered_skill.name }}</em> for <em>{{ req.requested_skill.name }}</em>
          </div>
          <form method="post" action="{% url 'accept_swap_request' req.id %}" class="mb-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-success btn-sm">Accept</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No incoming swap requests.</p>
  {% endif %}
{% else %}
  <div class="alert alert-info" role="alert">
    Please <a href="{% url 'login' %}">login</a> or <a href="{% url 'register' %}">register</a> to send or accept swap requests.
  </div>
{% endif %}

<hr class="my-4" />

{% if profiles %}
  {% for profile in profiles %}
    <div class="card mb-3 shadow-sm">
      <div class="card-body d-flex flex-wrap align-items-center">
        {% if profile.profile_photo %}
          <img
            src="{{ profile.profile_photo.url }}"
            width="70"
            height="70"
            class="rounded-circle me-3"
            alt="{{ profile.user.username }}'s Profile photo"
          />
        {% else %}
          <div
            class="bg-secondary rounded-circle me-3"
            style="width:70px; height:70px;"
            aria-label="No profile photo"
          ></div>
        {% endif %}

        <div class="flex-grow-1">
          <h5 class="mb-1">
            <a href="{% url 'user_profile' profile.user.id %}" class="text-decoration-none">
              {{ profile.user.username }}
            </a>
          </h5>
          <small class="text-muted">{{ profile.availability }}</small> |
          <small class="text-muted">{{ profile.location }}</small>

          <p class="mt-2 mb-1"><strong>Skills Offered:</strong>
            {% for skill in profile.skills_offered.all %}
              {{ skill.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              None
            {% endfor %}
          </p>
          <p class="mb-0"><strong>Skills Wanted:</strong>
            {% for skill in profile.skills_wanted.all %}
              {{ skill.name }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              None
            {% endfor %}
          </p>
        </div>

        {% if user.is_authenticated and user != profile.user %}
          <div class="ms-auto mt-3 mt-md-0">
            <a href="{% url 'send_swap_request' profile.user.id %}" class="btn btn-primary btn-sm">
              Request Swap
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <p>No users found.</p>
{% endif %}
{% endblock %}
